name: Check for new SABnzbd release

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC
  workflow_dispatch:

jobs:
  check-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest SABnzbd release
        id: sabnzbd
        run: |
          LATEST=$(curl -fsSL https://api.github.com/repos/sabnzbd/sabnzbd/releases/latest | jq -r '.tag_name')
          echo "latest=${LATEST}" >> "${GITHUB_OUTPUT}"

      - name: Get current version
        id: current
        run: |
          CURRENT=$(cat apps/sabnzbd/VERSION | tr -d '[:space:]')
          echo "current=${CURRENT}" >> "${GITHUB_OUTPUT}"

      - name: Log version comparison
        run: |
          echo "Current: ${{ steps.current.outputs.current }}"
          echo "Latest:  ${{ steps.sabnzbd.outputs.latest }}"

      - name: Update VERSION file
        if: steps.sabnzbd.outputs.latest != steps.current.outputs.current
        run: echo "${{ steps.sabnzbd.outputs.latest }}" > apps/sabnzbd/VERSION

      - name: Open PR with version bump
        if: steps.sabnzbd.outputs.latest != steps.current.outputs.current
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump SABnzbd to ${{ steps.sabnzbd.outputs.latest }}"
          branch: "update/sabnzbd-${{ steps.sabnzbd.outputs.latest }}"
          title: "chore: bump SABnzbd to ${{ steps.sabnzbd.outputs.latest }}"
          body: |
            Automated version bump for SABnzbd.

            | | Version |
            |---|---|
            | Previous | `${{ steps.current.outputs.current }}` |
            | New | `${{ steps.sabnzbd.outputs.latest }}` |

            Merging this PR will trigger the Docker image build workflow.

            [SABnzbd ${{ steps.sabnzbd.outputs.latest }} release notes](https://github.com/sabnzbd/sabnzbd/releases/tag/${{ steps.sabnzbd.outputs.latest }})
          labels: automated,dependency-update
